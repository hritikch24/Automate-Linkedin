/**
 * Add facts to YouTube description during upload
 */
async function enhanceYouTubeUpload(auth, videoId, facts, category) {
  try {
    const { google } = require('googleapis');
    const youtube = google.youtube('v3');
    
    console.log(`Enhancing YouTube video ${videoId} with facts in description...`);
    
    // Format the title
    const title = `${facts.length} Amazing ${category.charAt(0).toUpperCase() + category.slice(1)} Facts`;
    
    // Format facts for description
    const factsText = facts.map((fact, index) => {
      const factText = typeof fact === 'string' ? fact : (fact.text || 'Interesting fact');
      return `Fact ${index + 1}: ${factText}`;
    }).join('\n\n');
    
    // Create full description
    const description = `${title}\n\n${factsText}\n\nAutomatically generated by Facts Bot. Like and subscribe for more interesting facts!`;
    
    // Update video with facts in description
    await youtube.videos.update({
      auth,
      part: 'snippet',
      requestBody: {
        id: videoId,
        snippet: {
          title: title,
          description: description,
          categoryId: '27' // Education category
        }
      }
    });
    
    console.log(`Successfully updated video ${videoId} with facts in description`);
    return true;
  } catch (error) {
    console.error('Error enhancing YouTube upload:', error.message);
    if (error.response) {
      console.error('API Error:', error.response.data);
    }
    return false;
  }
}

/**
 * Absolute minimal video generator that will definitely work in GitHub Actions
 */

const fs = require('fs-extra');
const { execSync } = require('child_process');
const path = require('path');

/**
 * Create the simplest possible video - guaranteed to work
 */
async function createSimplestVideo(facts, category, outputPath) {
  console.log('Creating the simplest possible video...');
  
  try {
    // Ensure the output directory exists
    const outputDir = path.dirname(outputPath);
    await fs.ensureDir(outputDir);
    
    // Create description file with facts
    const title = `${facts.length} Amazing ${category.charAt(0).toUpperCase() + category.slice(1)} Facts`;
    
    // Format facts for description
    const factsText = facts.map((fact, index) => {
      const factText = typeof fact === 'string' ? fact : (fact.text || 'Interesting fact');
      return `Fact ${index + 1}: ${factText}`;
    }).join('\n\n');
    
    // Save description to file
    const descriptionFile = `${outputPath}.description.txt`;
    const descriptionText = `${title}\n\n${factsText}\n\nAutomatically generated by Facts Bot.`;
    await fs.writeFile(descriptionFile, descriptionText);
    console.log(`Video description saved to: ${descriptionFile}`);
    
    // Create the absolute simplest video possible
    // This command should work on any system with FFmpeg installed
    console.log('Running FFmpeg to create a simple video...');
    
    const ffmpegCommand = `ffmpeg -f lavfi -i color=c=blue:s=1280x720:d=30 -c:v libx264 -pix_fmt yuv420p -y "${outputPath}"`;
    
    console.log(`Executing command: ${ffmpegCommand}`);
    execSync(ffmpegCommand, { stdio: 'inherit' });
    
    console.log(`Video created successfully at: ${outputPath}`);
    return {
      videoPath: outputPath,
      descriptionPath: descriptionFile
    };
  } catch (error) {
    console.error('Error creating simplest video:', error.message);
    throw error;
  }
}

module.exports = { 
  createSimplestVideo,
  enhanceYouTubeUpload
};