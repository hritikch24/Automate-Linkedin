/**
 * Add facts to YouTube description during upload
 */
async function enhanceYouTubeUpload(auth, videoId, facts, category) {
  try {
    const { google } = require('googleapis');
    const youtube = google.youtube('v3');
    
    console.log(`Enhancing YouTube video ${videoId} with facts in description...`);
    
    // Get the current video details first
    const videoResponse = await youtube.videos.list({
      auth,
      part: 'snippet',
      id: videoId
    });
    
    if (!videoResponse.data.items || videoResponse.data.items.length === 0) {
      console.error('Could not find video with ID:', videoId);
      return false;
    }
    
    const videoSnippet = videoResponse.data.items[0].snippet;
    
    // Format the title - make sure we have at least 5 facts
    const factsCount = facts && facts.length > 0 ? facts.length : 5;
    const title = `${factsCount} Amazing ${category.charAt(0).toUpperCase() + category.slice(1)} Facts You Never Knew!`;
    
    // Ensure we have facts even if array is empty
    let formattedFacts = [];
    if (facts && facts.length > 0) {
      formattedFacts = facts.map((fact, index) => {
        const factText = typeof fact === 'string' ? fact : (fact.text || 'Interesting fact');
        return `Fact ${index + 1}: ${factText}`;
      });
    } else {
      // Use fallback facts from default description
      const description = videoSnippet.description;
      const lines = description.split('\n');
      for (const line of lines) {
        if (line.startsWith('Fact ')) {
          formattedFacts.push(line);
        }
      }
      
      // If still no facts, create generic ones
      if (formattedFacts.length === 0) {
        formattedFacts = [
          "Fact 1: The human brain can process images in as little as 13 milliseconds.",
          "Fact 2: The Earth is not a perfect sphere; it's an oblate spheroid, flattened at the poles.",
          "Fact 3: There are more possible iterations of a game of chess than there are atoms in the universe.",
          "Fact 4: Honey never spoils. Archaeologists have found pots of honey from ancient Egyptian tombs that are over 3,000 years old.",
          "Fact 5: The longest recorded flight of a chicken is 13 seconds."
        ];
      }
    }
    
    // Create full description
    const description = `${title}\n\n${formattedFacts.join('\n\n')}\n\nLike and subscribe for more interesting facts!`;
    
    // Update video with facts in description
    await youtube.videos.update({
      auth,
      part: 'snippet',
      requestBody: {
        id: videoId,
        snippet: {
          title: title,
          description: description,
          categoryId: videoSnippet.categoryId || '27', // Keep existing or use Education category
          tags: videoSnippet.tags || ['facts', 'amazing facts', 'did you know']
        }
      }
    });
    
    console.log(`Successfully updated video ${videoId} with facts in description`);
    return true;
  } catch (error) {
    console.error('Error enhancing YouTube upload:', error.message);
    if (error.response) {
      console.error('API Error:', error.response.data);
    }
    return false;
  }
}

/**
 * Absolute minimal video generator that will definitely work in GitHub Actions
 */

const fs = require('fs-extra');
const { execSync } = require('child_process');
const path = require('path');

/**
 * Create the simplest possible video - guaranteed to work
 */
async function createSimplestVideo(facts, category, outputPath) {
  console.log('Creating the simplest possible video...');
  
  try {
    // Ensure the output directory exists
    const outputDir = path.dirname(outputPath);
    await fs.ensureDir(outputDir);
    
    // Ensure facts is never empty
    const validFacts = facts && facts.length > 0 ? facts : [
      { text: "The human brain can process images in as little as 13 milliseconds." },
      { text: "The Earth is not a perfect sphere; it's an oblate spheroid, flattened at the poles." },
      { text: "There are more possible iterations of a game of chess than there are atoms in the universe." },
      { text: "Honey never spoils. Archaeologists have found pots of honey from ancient Egyptian tombs that are over 3,000 years old." },
      { text: "The longest recorded flight of a chicken is 13 seconds." }
    ];
    
    // Create description file with facts
    const title = `${validFacts.length} Amazing ${category.charAt(0).toUpperCase() + category.slice(1)} Facts`;
    
    // Format facts for description
    const factsText = validFacts.map((fact, index) => {
      const factText = typeof fact === 'string' ? fact : (fact.text || 'Interesting fact');
      return `Fact ${index + 1}: ${factText}`;
    }).join('\n\n');
    
    // Save description to file
    const descriptionFile = `${outputPath}.description.txt`;
    const descriptionText = `${title}\n\n${factsText}\n\nAutomatically generated by Facts Bot.`;
    await fs.writeFile(descriptionFile, descriptionText);
    console.log(`Video description saved to: ${descriptionFile}`);
    
    // Create the absolute simplest video possible
    // This command should work on any system with FFmpeg installed
    console.log('Running FFmpeg to create a simple video...');
    
    const ffmpegCommand = `ffmpeg -f lavfi -i color=c=blue:s=1280x720:d=30 -c:v libx264 -pix_fmt yuv420p -y "${outputPath}"`;
    
    console.log(`Executing command: ${ffmpegCommand}`);
    execSync(ffmpegCommand, { stdio: 'inherit' });
    
    console.log(`Video created successfully at: ${outputPath}`);
    return {
      videoPath: outputPath,
      descriptionPath: descriptionFile
    };
  } catch (error) {
    console.error('Error creating simplest video:', error.message);
    throw error;
  }
}

module.exports = { 
  createSimplestVideo,
  enhanceYouTubeUpload
};